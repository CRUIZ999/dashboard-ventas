<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard de Ventas ‚Äì Filtros r√°pidos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    body {
      margin: 0;
      background: #020617;
      color: #e5e7eb;
    }
    .page {
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px;
    }
    h1 {
      margin: 0;
      font-size: 24px;
      font-weight: 800;
    }
    .sub {
      margin: 4px 0 0;
      font-size: 12px;
      color: #9ca3af;
    }
    .top-bar {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 12px;
      align-items: center;
      margin-bottom: 16px;
    }
    .btn-file {
      background: #0f172a;
      border: 1px solid #374151;
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 13px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: #e5e7eb;
    }
    .btn-file:hover {
      background: #111827;
    }
    input[type="file"] {
      display: none;
    }
    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
      margin-bottom: 16px;
    }
    .card {
      background: #020617;
      border-radius: 16px;
      border: 1px solid #1f2937;
      padding: 10px 12px;
    }
    .card-title {
      font-size: 10px;
      text-transform: uppercase;
      color: #9ca3af;
      letter-spacing: .06em;
    }
    .card-value {
      font-size: 18px;
      font-weight: 700;
      margin-top: 4px;
    }
    .card-sub {
      font-size: 10px;
      color: #6b7280;
      margin-top: 2px;
    }
    .filters-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 8px 0;
      gap: 8px;
    }
    .filters-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 8px;
      margin-bottom: 12px;
    }
    .filter-block {
      background: #020617;
      border-radius: 12px;
      border: 1px solid #1f2937;
      padding: 6px 8px;
      font-size: 11px;
    }
    .filter-label {
      font-size: 10px;
      text-transform: uppercase;
      color: #9ca3af;
      margin-bottom: 3px;
    }
    .filter-search {
      width: 100%;
      font-size: 10px;
      padding: 3px 6px;
      border-radius: 6px;
      border: 1px solid #1f2937;
      background: #020617;
      color: #e5e7eb;
      margin-bottom: 4px;
    }
    .filter-search::placeholder {
      color: #6b7280;
    }
    select {
      width: 100%;
      font-size: 11px;
      padding: 4px 6px;
      border-radius: 6px;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
    }
    select:focus {
      outline: 1px solid #6366f1;
    }
    .btn-small {
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      cursor: pointer;
    }
    .btn-small:hover {
      background: #111827;
    }
    .table-wrapper {
      border-radius: 16px;
      border: 1px solid #1f2937;
      background: #020617;
      overflow: hidden;
      max-height: 70vh;
      display: flex;
      flex-direction: column;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      font-size: 11px;
    }
    thead {
      position: sticky;
      top: 0;
      background: #020617;
      z-index: 1;
    }
    th, td {
      padding: 4px 8px;
      white-space: nowrap;
      border-bottom: 1px solid #020617;
    }
    th {
      font-size: 10px;
      text-transform: uppercase;
      color: #9ca3af;
      cursor: pointer;
      user-select: none;
    }
    th:hover {
      background: #0b1120;
    }
    tbody tr:hover {
      background: #020617;
    }
    .scroll-x {
      overflow-x: auto;
    }
    .message {
      font-size: 11px;
      color: #9ca3af;
      margin-top: 6px;
    }
    .hidden {
      display: none !important;
    }
    /* celdas con valores negativos */
    .negativo {
      color: #f97373;
      font-weight: 600;
    }
    /* estilos para encabezados ordenados */
    th.orden-activo {
      background: #0b1120;
      color: #ffffff;
    }
    th .icon-orden {
      margin-left: 4px;
      font-size: 9px;
      opacity: 0.6;
    }
    th.orden-activo .icon-orden {
      opacity: 1;
    }
  </style>
</head>
<body>
<div class="page">
  <div class="top-bar">
    <div>
      <h1>Dashboard de Ventas</h1>
      <p class="sub">Sube un archivo CSV exportado desde Excel y filtra por a√±o, almac√©n, tipo de factura, cliente, vendedor y categor√≠a.</p>
    </div>
    <label class="btn-file">
      üìÅ Subir archivo CSV
      <input id="fileInput" type="file" accept=".csv">
    </label>
  </div>

  <div id="summary" class="cards hidden">
    <div class="card">
      <div class="card-title">Registros</div>
      <div id="sumRows" class="card-value">0</div>
      <div class="card-sub">Filas visibles despu√©s de filtros</div>
    </div>
    <div class="card">
      <div class="card-title">Suma Subtotal</div>
      <div id="sumSubt" class="card-value">$0</div>
      <div class="card-sub">Columna: subt_fac</div>
    </div>
    <div class="card">
      <div class="card-title">Suma Total</div>
      <div id="sumTotal" class="card-value">$0</div>
      <div class="card-sub">Columna: total_fac</div>
    </div>
  </div>

  <div id="filtersArea" class="hidden">
    <div class="filters-header">
      <div style="font-size: 13px; font-weight: 600;">Filtros</div>
      <button id="btnClear" class="btn-small">Limpiar filtros</button>
    </div>
    <div class="filters-container" id="filtersContainer">
      <!-- filtros din√°micos -->
    </div>
  </div>

  <div id="tableArea" class="hidden">
    <div class="table-wrapper">
      <div class="scroll-x">
        <table id="dataTable"></table>
      </div>
    </div>
    <div id="tableNote" class="message"></div>
  </div>

  <p id="message" class="message"></p>
</div>

<script>
  // --------- CONFIGURACI√ìN --------- //
  const MAX_ROWS_RENDER = 2000; // filas m√°x a mostrar

  // colIndex: refuerzo por posici√≥n (A=0, B=1, ..., H=7, L=11, Z=25)
  const FILTER_CONFIG = [
    {key: "anio",       labels: ["a√±o", "anio", "year"],            title: "A√±o",            colIndex: 0},
    {key: "almacen",    labels: ["almacen", "almac√©n", "sucursal"], title: "Almac√©n"},
    {key: "tipoFactura",labels: ["tipo de factura", "tipo_factura"],title: "Tipo de Factura", colIndex: 7},
    {key: "cliente",    labels: ["cliente"],                        title: "Cliente"},
    {key: "vendedor",   labels: ["vendedor"],                       title: "Vendedor",       colIndex: 25},
    {key: "categoria",  labels: ["categoria", "categor√≠a"],         title: "Categor√≠a",      colIndex: 11}
  ];

  // --------- ESTADO --------- //
  let originalData = [];
  let filteredData = [];
  let columns = [];
  let filters = {};
  let sortState = { column: null, asc: true };

  // --------- ELEMENTOS --------- //
  const fileInput = document.getElementById("fileInput");
  const msgEl = document.getElementById("message");
  const summaryEl = document.getElementById("summary");
  const sumRowsEl = document.getElementById("sumRows");
  const sumSubtEl = document.getElementById("sumSubt");
  const sumTotalEl = document.getElementById("sumTotal");
  const filtersArea = document.getElementById("filtersArea");
  const filtersContainer = document.getElementById("filtersContainer");
  const btnClear = document.getElementById("btnClear");
  const tableArea = document.getElementById("tableArea");
  const tableEl = document.getElementById("dataTable");
  const tableNote = document.getElementById("tableNote");

  function normalize(str) {
    return (str || "")
      .toString()
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "")
      .toLowerCase()
      .trim();
  }

  // --------- LECTURA CSV --------- //
  fileInput.addEventListener("change", () => {
    const file = fileInput.files[0];
    if (!file) return;

    msgEl.textContent = "Leyendo archivo...";

    const reader = new FileReader();
    reader.onload = (e) => {
      const text = e.target.result;

      const firstLine = text.split(/\r?\n/)[0] || "";
      const semis = (firstLine.match(/;/g) || []).length;
      const commas = (firstLine.match(/,/g) || []).length;
      const delim = semis > commas ? ";" : ",";

      const lines = text.split(/\r?\n/).filter(l => l.trim() !== "");
      if (lines.length < 2) {
        msgEl.textContent = "El archivo no tiene datos suficientes.";
        return;
      }

      const headerCells = lines[0].split(delim).map(c => c.trim());
      columns = headerCells;

      const rows = [];
      for (let i = 1; i < lines.length; i++) {
        const parts = lines[i].split(delim);
        const rowObj = {};
        for (let j = 0; j < headerCells.length; j++) {
          rowObj[headerCells[j]] = (parts[j] || "").trim();
        }
        rows.push(rowObj);
      }

      originalData = rows;
      filteredData = rows.slice();

      if (!originalData.length) {
        msgEl.textContent = "No se encontraron filas en el archivo.";
        return;
      }

      buildFilters();
      applyFilters();

      summaryEl.classList.remove("hidden");
      filtersArea.classList.remove("hidden");
      tableArea.classList.remove("hidden");

      const info = originalData.length.toLocaleString("es-MX");
      msgEl.textContent = `Archivo cargado correctamente (${info} filas, ${columns.length} columnas).`;
    };

    reader.onerror = () => {
      msgEl.textContent = "Error al leer el archivo.";
    };

    reader.readAsText(file, "utf-8");
  });

  // --------- FILTROS --------- //
  function getHeaderByLabelsOrIndex(cfg) {
    const normCols = columns.map(c => normalize(c));
    // 1) por nombre
    for (const lb of (cfg.labels || [])) {
      const idx = normCols.indexOf(normalize(lb));
      if (idx !== -1) return columns[idx];
    }
    // 2) por √≠ndice expl√≠cito
    if (typeof cfg.colIndex === "number" && columns[cfg.colIndex]) {
      return columns[cfg.colIndex];
    }
    return null;
  }

  function buildFilters() {
    filtersContainer.innerHTML = "";
    filters = {};

    FILTER_CONFIG.forEach(cfg => {
      const header = getHeaderByLabelsOrIndex(cfg);
      if (!header) return;

      const setVals = new Set(
        originalData.map(r => r[header]).filter(v => v !== "")
      );
      const allValues = Array.from(setVals).sort((a, b) =>
        String(a).localeCompare(String(b), "es", {numeric: true})
      );

      filters[cfg.key] = { header: header, value: "TODOS" };

      const block = document.createElement("div");
      block.className = "filter-block";

      const label = document.createElement("div");
      label.className = "filter-label";
      label.textContent = `${cfg.title} (${header})`;
      block.appendChild(label);

      const search = document.createElement("input");
      search.type = "text";
      search.placeholder = "Buscar...";
      search.className = "filter-search";
      block.appendChild(search);

      const sel = document.createElement("select");
      sel.dataset.filterKey = cfg.key;
      block.appendChild(sel);

      function renderOptions(term = "") {
        const normTerm = normalize(term);
        sel.innerHTML = "";

        const optAll = document.createElement("option");
        optAll.value = "TODOS";
        optAll.textContent = "Todos";
        sel.appendChild(optAll);

        allValues
          .filter(v => !normTerm || normalize(String(v)).includes(normTerm))
          .forEach(v => {
            const opt = document.createElement("option");
            opt.value = v;
            opt.textContent = v;
            sel.appendChild(opt);
          });

        if (filters[cfg.key].value && filters[cfg.key].value !== "TODOS") {
          sel.value = filters[cfg.key].value;
          if (sel.value !== filters[cfg.key].value) {
            filters[cfg.key].value = "TODOS";
            sel.value = "TODOS";
          }
        }
      }

      renderOptions();

      search.addEventListener("input", e => {
        renderOptions(e.target.value);
      });

      sel.addEventListener("change", e => {
        const key = e.target.dataset.filterKey;
        filters[key].value = e.target.value;
        applyFilters();
      });

      filtersContainer.appendChild(block);
    });

    btnClear.onclick = () => {
      Object.keys(filters).forEach(k => {
        filters[k].value = "TODOS";
      });
      filtersContainer.querySelectorAll("select").forEach(s => {
        s.value = "TODOS";
      });
      filtersContainer.querySelectorAll(".filter-search").forEach(i => {
        i.value = "";
      });
      applyFilters();
    };
  }

  function applyFilters() {
    filteredData = originalData.filter(row => {
      for (const key in filters) {
        const f = filters[key];
        if (f.value === "TODOS") continue;
        if (row[f.header] !== f.value) return false;
      }
      return true;
    });

    if (sortState.column) {
      sortByColumn(sortState.column, sortState.asc, false);
    }

    renderTable();
    updateSummary();
  }

  // --------- TABLA --------- //
  function renderTable() {
    if (!columns.length) return;

    let html = "";

    // encabezado con iconos de orden
    html += "<thead><tr>";
    columns.forEach(col => {
      const isSorted = sortState.column === col;
      const icon = isSorted ? (sortState.asc ? "‚ñ≤" : "‚ñº") : "‚ñ≤‚ñº";
      const cls = isSorted ? "orden-activo" : "";
      html += `
        <th data-col="${escapeHtml(col)}" class="${cls}">
          ${escapeHtml(col)}
          <span class="icon-orden">${icon}</span>
        </th>`;
    });
    html += "</tr></thead>";

    // cuerpo
    const rowsToShow = filteredData.slice(0, MAX_ROWS_RENDER);

    html += "<tbody>";
    rowsToShow.forEach(row => {
      html += "<tr>";
      columns.forEach(col => {
        const val = row[col] || "";
        const num = parseFloat(String(val).replace(/[^0-9.-]+/g, ""));
        const isNeg = !isNaN(num) && num < 0;
        const cls = isNeg ? "negativo" : "";
        html += `<td class="${cls}">${escapeHtml(val)}</td>`;
      });
      html += "</tr>";
    });
    html += "</tbody>";

    tableEl.innerHTML = html;

    // eventos ordenar
    tableEl.querySelectorAll("th[data-col]").forEach(th => {
      th.addEventListener("click", () => {
        const col = th.getAttribute("data-col");
        const asc = !(sortState.column === col && sortState.asc === true);
        sortByColumn(col, asc, true);
      });
    });

    if (filteredData.length > MAX_ROWS_RENDER) {
      tableNote.textContent =
        `Mostrando las primeras ${MAX_ROWS_RENDER.toLocaleString("es-MX")} filas de ` +
        `${filteredData.length.toLocaleString("es-MX")} (los totales usan todas).`;
    } else {
      tableNote.textContent = "";
    }
  }

  function sortByColumn(col, asc, rerender) {
    filteredData.sort((a, b) => {
      const va = a[col] || "";
      const vb = b[col] || "";

      const na = parseFloat(String(va).replace(/[^0-9.-]+/g, ""));
      const nb = parseFloat(String(vb).replace(/[^0-9.-]+/g, ""));
      const bothNum = !isNaN(na) && !isNaN(nb);

      if (bothNum) {
        return asc ? na - nb : nb - na;
      } else {
        return asc
          ? String(va).localeCompare(String(vb), "es", {numeric: true})
          : String(vb).localeCompare(String(va), "es", {numeric: true});
      }
    });

    sortState.column = col;
    sortState.asc = asc;

    if (rerender) {
      renderTable();
    }
  }

  // --------- RESUMEN --------- //
  function updateSummary() {
    sumRowsEl.textContent = filteredData.length.toLocaleString("es-MX");

    const subtHeader = columns.find(c => normalize(c) === "subt_fac");
    const totalHeader = columns.find(c => normalize(c) === "total_fac");

    let subt = 0;
    let total = 0;

    if (subtHeader) {
      filteredData.forEach(row => {
        const n = parseFloat(String(row[subtHeader]).replace(/[^0-9.-]+/g, ""));
        if (!isNaN(n)) subt += n;
      });
    }

    if (totalHeader) {
      filteredData.forEach(row => {
        const n = parseFloat(String(row[totalHeader]).replace(/[^0-9.-]+/g, ""));
        if (!isNaN(n)) total += n;
      });
    }

    sumSubtEl.textContent = formatMoney(subt);
    sumTotalEl.textContent = formatMoney(total);
  }

  function formatMoney(n) {
    return n.toLocaleString("es-MX", {
      style: "currency",
      currency: "MXN",
      maximumFractionDigits: 0
    });
  }

  function escapeHtml(value) {
    return String(value)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;");
  }
</script>
</body>
</html>
