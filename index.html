<script>
  // ------------------ VARIABLES GLOBALES ------------------ //
  let originalData = [];  // arreglo de objetos (todas las filas)
  let filteredData = [];
  let columns = [];
  let filtersMap = {};    // { key: { header: 'año', selected: Set([...]) } }
  let sortState = { column: null, asc: true };

  // *** Límite de filas a dibujar en la tabla (para que no se congele) ***
  const MAX_ROWS_RENDER = 10000;

  // columnas en las que intentaremos crear segmentadores
  const FILTER_GROUPS = [
    { key: "anio", labels: ["año", "anio", "year"] },
    { key: "almacen", labels: ["almacen", "almacén", "sucursal"] },
    { key: "tipoFactura", labels: ["tipo de factura", "tipo_factura"] },
    { key: "cliente", labels: ["cliente"] },
    { key: "vendedor", labels: ["vendedor"] },
    { key: "categoria", labels: ["categoria", "categoría"] },
  ];

  const fileInput = document.getElementById("fileInput");
  const messageEl = document.getElementById("message");
  const filtersSection = document.getElementById("filtersSection");
  const filtersContainer = document.getElementById("filtersContainer");
  const tableSection = document.getElementById("tableSection");
  const dataTable = document.getElementById("dataTable");
  const summaryCards = document.getElementById("summaryCards");
  const summaryRows = document.getElementById("summaryRows");
  const summarySubt = document.getElementById("summarySubt");
  const summaryTotal = document.getElementById("summaryTotal");
  const clearFiltersBtn = document.getElementById("clearFiltersBtn");

  function normalize(str) {
    return (str || "")
      .toString()
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "")
      .toLowerCase()
      .trim();
  }

  // ------------------ LECTURA DEL ARCHIVO ------------------ //
  fileInput.addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (!file) return;

    if (!file.name.toLowerCase().endsWith(".csv")) {
      messageEl.textContent = "Por ahora esta página solo acepta archivos CSV. Exporta tu tabla de Excel a CSV.";
      return;
    }

    messageEl.textContent = "Cargando archivo...";

    const tempRows = [];
    let rowCount = 0;

    Papa.parse(file, {
      header: true,
      skipEmptyLines: true,
      worker: true,             // usa worker (segundo plano)
      step: function (row) {    // se ejecuta por cada fila
        tempRows.push(row.data);
        rowCount++;
        // Actualiza mensaje cada cierto número de filas para no saturar
        if (rowCount % 5000 === 0) {
          messageEl.textContent = `Leyendo archivo... ${rowCount.toLocaleString("es-MX")} filas`;
        }
      },
      complete: function (results) {
        if (results.errors && results.errors.length) {
          console.error(results.errors);
          messageEl.textContent = "Hubo errores al leer el CSV. Revisa el separador (coma) y los encabezados.";
          return;
        }

        originalData = tempRows;
        filteredData = [...originalData];
        columns = originalData.length ? Object.keys(originalData[0]) : [];

        if (!originalData.length) {
          messageEl.textContent = "El archivo se cargó pero no se encontraron filas (¿tiene encabezados en la primera fila?).";
          return;
        }

        buildFilters();
        renderTable();
        updateSummary();
        filtersSection.classList.remove("hidden");
        tableSection.classList.remove("hidden");
        summaryCards.classList.remove("hidden");

        const avisoLimite =
          originalData.length > MAX_ROWS_RENDER
            ? ` (mostrando las primeras ${MAX_ROWS_RENDER.toLocaleString("es-MX")} filas en la tabla)`
            : "";

        messageEl.textContent =
          `Archivo cargado con ${originalData.length.toLocaleString("es-MX")} filas y ${columns.length} columnas${avisoLimite}.`;
      },
      error: function (err) {
        console.error(err);
        messageEl.textContent = "Error al leer el CSV: " + err.message;
      }
    });
  });

  // ------------------ FILTROS ------------------ //
  function findHeaderByLabels(labels) {
    const normalizedCols = columns.map((c) => normalize(c));
    for (const label of labels) {
      const normLabel = normalize(label);
      const idx = normalizedCols.indexOf(normLabel);
      if (idx !== -1) return columns[idx];
    }
    return null;
  }

  function buildFilters() {
    filtersContainer.innerHTML = "";
    filtersMap = {};

    FILTER_GROUPS.forEach((group) => {
      const header = findHeaderByLabels(group.labels);
      if (!header) return; // esa columna no existe en este archivo

      const valuesSet = new Set(
        originalData
          .map((row) => row[header])
          .filter((v) => v !== undefined && v !== null && v !== "")
      );
      const values = Array.from(valuesSet).sort((a, b) =>
        String(a).localeCompare(String(b), "es", { numeric: true })
      );

      filtersMap[group.key] = {
        header,
        selected: new Set(), // vacío = todos
      };

      const filterCard = document.createElement("div");
      filterCard.className =
        "rounded-xl bg-slate-800/80 border border-slate-700 p-3 flex flex-col gap-2 shadow";

      const title = document.createElement("div");
      title.className = "flex items-center justify-between gap-2";
      title.innerHTML = `
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">
          ${header}
        </span>
        <button class="text-[10px] px-2 py-0.5 rounded-full bg-slate-900/70 border border-slate-600 hover:bg-slate-700"
          data-clear="${group.key}">
          Todos
        </button>
      `;
      filterCard.appendChild(title);

      // Input de búsqueda
      const searchInput = document.createElement("input");
      searchInput.type = "text";
      searchInput.placeholder = "Buscar...";
      searchInput.className =
        "text-xs bg-slate-900/70 border border-slate-600 rounded-md px-2 py-1 focus:outline-none focus:ring-1 focus:ring-indigo-500";
      filterCard.appendChild(searchInput);

      // Contenedor de opciones
      const optionsWrapper = document.createElement("div");
      optionsWrapper.className =
        "mt-1 max-h-40 overflow-y-auto space-y-1 text-xs";
      filterCard.appendChild(optionsWrapper);

      function renderOptions(filterText = "") {
        optionsWrapper.innerHTML = "";
        const normFilter = normalize(filterText);

        values
          .filter((v) => !normFilter || normalize(String(v)).includes(normFilter))
          .forEach((val) => {
            const id = `${group.key}-${normalize(String(val)).replace(/[^a-z0-9]+/g, "-")}`;
            const wrapper = document.createElement("label");
            wrapper.className = "flex items-center gap-2 cursor-pointer";
            const checked = filtersMap[group.key].selected.has(val);

            wrapper.innerHTML = `
              <input type="checkbox" id="${id}" value="${val}"
                class="h-3 w-3 rounded border-slate-500 bg-slate-900 text-indigo-500"
                ${checked ? "checked" : ""}/>
              <span class="truncate" title="${val}">${val}</span>
            `;
            optionsWrapper.appendChild(wrapper);
          });
      }

      renderOptions();

      // Eventos
      searchInput.addEventListener("input", (e) => {
        renderOptions(e.target.value);
      });

      filterCard.addEventListener("change", (e) => {
        if (e.target.type === "checkbox") {
          const val = e.target.value;
          const set = filtersMap[group.key].selected;
          if (e.target.checked) {
            set.add(val);
          } else {
            set.delete(val);
          }
          applyFilters();
        }
      });

      // botón "Todos" solo limpia selección
      title.querySelector("[data-clear]").addEventListener("click", () => {
        filtersMap[group.key].selected.clear();
        // desmarcar checkboxes
        optionsWrapper
          .querySelectorAll('input[type="checkbox"]')
          .forEach((chk) => (chk.checked = false));
        applyFilters();
      });

      filtersContainer.appendChild(filterCard);
    });
  }

  function applyFilters() {
    filteredData = originalData.filter((row) => {
      return Object.values(filtersMap).every((fObj) => {
        const value = row[fObj.header];
        const set = fObj.selected;
        if (!set || set.size === 0) return true; // sin filtro: pasa
        return set.has(value);
      });
    });

    renderTable();
    updateSummary();
  }

  clearFiltersBtn.addEventListener("click", () => {
    Object.values(filtersMap).forEach((f) => f.selected.clear());
    // desmarcar todas las casillas
    filtersContainer
      .querySelectorAll('input[type="checkbox"]')
      .forEach((chk) => (chk.checked = false));
    applyFilters();
  });

  // ------------------ TABLA ------------------ //
  function renderTable() {
    if (!columns.length) return;
    let html = "";

    // encabezados
    html += `<thead class="bg-slate-800/90 text-xs uppercase text-slate-300 sticky top-0 z-10">
      <tr>`;
    columns.forEach((col, idx) => {
      const isSorted = sortState.column === col;
      html += `
        <th
          class="px-3 py-2 border-b border-slate-700 whitespace-nowrap cursor-pointer select-none hover:bg-slate-700/70"
          data-col-index="${idx}">
          <div class="flex items-center gap-1">
            <span>${col}</span>
            ${
              isSorted
                ? sortState.asc
                  ? "▲"
                  : "▼"
                : ""
            }
          </div>
        </th>`;
    });
    html += `</tr></thead>`;

    // cuerpo (sólo mostramos hasta MAX_ROWS_RENDER filas)
    const rowsToShow = filteredData.slice(0, MAX_ROWS_RENDER);

    html += `<tbody class="divide-y divide-slate-800 text-xs">`;
    rowsToShow.forEach((row) => {
      html += `<tr class="hover:bg-slate-800/70">`;
      columns.forEach((col) => {
        const val = row[col] ?? "";
        html += `<td class="px-3 py-1.5 whitespace-nowrap">${escapeHtml(
          val
        )}</td>`;
      });
      html += `</tr>`;
    });
    html += `</tbody>`;

    dataTable.innerHTML = html;

    // Eventos de ordenamiento
    dataTable
      .querySelectorAll("th[data-col-index]")
      .forEach((th) => th.addEventListener("click", onHeaderClick));
  }

  function escapeHtml(value) {
    return String(value)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;");
  }

  function onHeaderClick(e) {
    const idx = Number(e.currentTarget.getAttribute("data-col-index"));
    const col = columns[idx];
    if (!col) return;

    if (sortState.column === col) {
      sortState.asc = !sortState.asc;
    } else {
      sortState.column = col;
      sortState.asc = true;
    }

    filteredData.sort((a, b) => {
      const va = a[col];
      const vb = b[col];

      const na = parseFloat(String(va).replace(/[^0-9.-]+/g, ""));
      const nb = parseFloat(String(vb).replace(/[^0-9.-]+/g, ""));

      const bothNumeric = !isNaN(na) && !isNaN(nb);

      if (bothNumeric) {
        return sortState.asc ? na - nb : nb - na;
      } else {
        return sortState.asc
          ? String(va).localeCompare(String(vb), "es", { numeric: true })
          : String(vb).localeCompare(String(va), "es", { numeric: true });
      }
    });

    renderTable();
  }

  // ------------------ RESUMEN ------------------ //
  function updateSummary() {
    summaryRows.textContent = filteredData.length.toLocaleString("es-MX");

    const subtHeader = columns.find((c) => normalize(c) === "subt_fac");
    const totalHeader = columns.find((c) => normalize(c) === "total_fac");

    let subt = 0;
    let total = 0;

    if (subtHeader) {
      subt = filteredData.reduce((acc, row) => {
        const n = parseFloat(String(row[subtHeader]).replace(/[^0-9.-]+/g, ""));
        return acc + (isNaN(n) ? 0 : n);
      }, 0);
    }

    if (totalHeader) {
      total = filteredData.reduce((acc, row) => {
        const n = parseFloat(String(row[totalHeader]).replace(/[^0-9.-]+/g, ""));
        return acc + (isNaN(n) ? 0 : n);
      }, 0);
    }

    summarySubt.textContent = subt.toLocaleString("es-MX", {
      style: "currency",
      currency: "MXN",
      maximumFractionDigits: 0,
    });
    summaryTotal.textContent = total.toLocaleString("es-MX", {
      style: "currency",
      currency: "MXN",
      maximumFractionDigits: 0,
    });
  }
</script>
